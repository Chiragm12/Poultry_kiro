// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model ProductionCycle {
  id             String   @id @default(cuid())
  name           String   // Cycle name (e.g., "Batch 2024-01")
  startDate      DateTime // When the production cycle started
  startWeek      Int      @default(1) // Starting week number
  expectedEndWeek Int     @default(72) // Expected end week (typical laying cycle)
  isActive       Boolean  @default(true)
  farmId         String
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  farm         Farm         @relation(fields: [farmId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([farmId, isActive]) // Only one active cycle per farm
  @@index([farmId])
  @@index([organizationId])
  @@map("production_cycles")
}

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  email       String?
  phone       String?
  address     String?
  website     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users       User[]
  farms       Farm[]
  auditLogs   AuditLog[]
  jobRoles    JobRole[]
  productionCycles ProductionCycle[]

  @@map("organizations")
}

model User {
  id             String    @id @default(cuid())
  name           String?
  email          String?   @unique
  image          String?
  hashedPassword String?
  role           String    @default("WORKER") // OWNER, MANAGER, WORKER
  isActive       Boolean   @default(true)
  
  // Personal Information
  sex            String?   // M or F
  phone          String?
  phoneNumber    String?   // New field for consistency with API
  address        String?   // New field
  aadharNumber   String?   // New field for Indian Aadhar ID
  referral       String?   // Referral information
  alternateContact String? // Alternative contact number
  supervisorId   String?   // Manager/Supervisor ID
  notes          String?   // Notes/Others text area
  
  // Job Information
  jobRoleId      String?   // Reference to JobRole
  
  avatar         String?
  organizationId String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  accounts     Account[]
  sessions     Session[]
  
  // Farm management relations
  managedFarms Farm[] @relation("FarmManager")
  
  // Attendance relations
  attendanceRecords Attendance[]
  
  // Job role relation
  jobRole      JobRole?  @relation(fields: [jobRoleId], references: [id])
  
  // Supervisor relation
  supervisor   User?     @relation("UserSupervisor", fields: [supervisorId], references: [id])
  subordinates User[]    @relation("UserSupervisor")
  
  // Settings relation
  settings UserSettings?
  
  // Audit log relations
  auditLogs AuditLog[]

  @@index([organizationId])
  @@index([supervisorId])
  @@index([jobRoleId])
  @@map("users")
}

model JobRole {
  id             String   @id @default(cuid())
  title          String   // Job title (e.g., "Cleaner", "Feeder", "Supervisor")
  description    String?  // Job description
  salary         Decimal  // Salary amount
  salaryType     String   @default("MONTHLY") // HOURLY, DAILY, WEEKLY, MONTHLY, YEARLY
  isActive       Boolean  @default(true)
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  users        User[]

  @@index([organizationId])
  @@map("job_roles")
}

model Farm {
  id             String   @id @default(cuid())
  name           String
  location       String?
  description    String?
  isActive       Boolean  @default(true)
  
  // Bird counts
  maleCount      Int      @default(0)
  femaleCount    Int      @default(0)
  
  organizationId String
  managerId      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  manager      User?        @relation("FarmManager", fields: [managerId], references: [id])
  sheds        Shed[]
  productions  Production[]
  mortalityRecords MortalityRecord[]
  dispatchRecords  DispatchRecord[]
  flockManagement  FlockManagement[]
  productionCycles ProductionCycle[]

  @@index([organizationId])
  @@index([managerId])
  @@map("farms")
}

model Shed {
  id          String   @id @default(cuid())
  name        String
  capacity    Int
  description String?
  isActive    Boolean  @default(true)
  farmId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  farm             Farm               @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@map("sheds")
}

model Production {
  id           String   @id @default(cuid())
  date         DateTime
  
  // New egg categorization system
  tableEggs    Int      @default(0)  // Table eggs for consumption
  hatchingEggs Int      @default(0)  // Hatching eggs (normal eggs)
  crackedEggs  Int      @default(0)  // Cracked eggs
  jumboEggs    Int      @default(0)  // Jumbo eggs
  leakerEggs   Int      @default(0)  // Leaking eggs
  totalEggs    Int                   // Sum of all above categories (HD eggs)
  inchargeEggs Int      @default(0)  // Incharge eggs (total HD eggs + extra eggs)
  
  // Legacy fields for backward compatibility
  normalEggs   Int      @default(0)
  commEggs     Int      @default(0)
  waterEggs    Int      @default(0)
  jellyEggs    Int      @default(0)
  creakEggs    Int      @default(0)
  brokenEggs   Int      @default(0)
  damagedEggs  Int      @default(0)
  sellableEggs Int      @default(0)
  
  notes        String?
  farmId       String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)
  mortalityRecords MortalityRecord[]
  dispatchRecords  DispatchRecord[]

  @@unique([farmId, date])
  @@index([farmId])
  @@index([date])
  @@map("productions")
}

model FlockManagement {
  id             String   @id @default(cuid())
  date           DateTime
  ageWeeks       Int      // Age in weeks
  ageDayOfWeek   Int      // Day of the week (1-7)
  openingFemale  Int      // Opening female count
  openingMale    Int      // Opening male count
  mortalityF     Int      @default(0) // Female mortality
  mortalityM     Int      @default(0) // Male mortality
  closingFemale  Int      // Calculated: openingFemale - mortalityF
  closingMale    Int      // Calculated: openingMale - mortalityM
  farmId         String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@unique([farmId, date])
  @@index([farmId])
  @@index([date])
  @@map("flock_management")
}

model MortalityRecord {
  id           String   @id @default(cuid())
  date         DateTime
  maleMortality   Int   @default(0)
  femaleMortality Int   @default(0)
  notes        String?
  productionId String?
  farmId       String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  production Production? @relation(fields: [productionId], references: [id], onDelete: Cascade)
  farm       Farm        @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@index([date])
  @@map("mortality_records")
}

model DispatchRecord {
  id              String   @id @default(cuid())
  date            DateTime
  tableEggs       Int      @default(0) // Dispatched table eggs
  hatchingEggs    Int      @default(0) // Dispatched hatching eggs
  crackedEggs     Int      @default(0) // Dispatched cracked eggs
  jumboEggs       Int      @default(0) // Dispatched jumbo eggs
  leakerEggs      Int      @default(0) // Dispatched leaker eggs
  totalDispatched Int                  // Sum of all dispatched eggs
  notes           String?
  productionId    String?
  farmId          String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  production Production? @relation(fields: [productionId], references: [id], onDelete: Cascade)
  farm       Farm        @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@index([date])
  @@map("dispatch_records")
}

model Attendance {
  id        String   @id @default(cuid())
  date      DateTime
  status    String   @default("PRESENT") // PRESENT, ABSENT, LATE, HALF_DAY
  notes     String?
  userId    String
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
  @@map("attendance")
}

model AuditLog {
  id             String      @id @default(cuid())
  action         String      @default("CREATE") // CREATE, UPDATE, DELETE, LOGIN, LOGOUT
  entityType     String // e.g., "User", "Farm", "Production"
  entityId       String?
  oldValues      String? // JSON string
  newValues      String? // JSON string
  userId         String?
  organizationId String
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime    @default(now())

  // Relations
  user         User?        @relation(fields: [userId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

model UserSettings {
  id                      String   @id @default(cuid())
  userId                  String   @unique
  
  // Notification settings
  emailNotifications      Boolean  @default(true)
  smsNotifications        Boolean  @default(false)
  productionAlerts        Boolean  @default(true)
  attendanceAlerts        Boolean  @default(true)
  lowProductionThreshold  Int      @default(80)
  attendanceThreshold     Int      @default(85)
  
  // System settings
  timezone                String   @default("UTC")
  dateFormat              String   @default("MM/DD/YYYY")
  currency                String   @default("USD")
  language                String   @default("en")
  theme                   String   @default("light")
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_settings")
}